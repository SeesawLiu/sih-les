@using com.Sconit.Entity.ORD
@using com.Sconit.Entity.SYS
@using com.Sconit.Web.Models.SearchModels.ORD
@{
    ViewBag.Title = "Index";
    Html.RenderAction("_SiteMapPath", "Common", new { MenuContent = "Url_PickList_Ship" });
}


    <script type="text/javascript">
        function doSearch() {
            if ($("#PickListNo").val() == "") {
                $("#errorsul").html("请输入拣货单进行查询。");
                return;
            }
            var data = {
                "PickListNo": $("#PickListNo").val()
            }

            $.ajax({
                type: "post",
                dataType: "html",
                data: data,
                url: "/PickList/_PickDetailList/",
                cache: false,
                success: function (data, textStatus) {
                    $("#errorsul").html('');
                    $("#PickDetailListDiv").html(data);
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    debugger
                    var errorMessages = "<li>" + XMLHttpRequest.responseText + "</li>";
                    var errors = errorMessages.split('*');
                    $("#errorsul").html(errors[0]);
                    $("#successesul").html('');

                }
            });
        }

        function onSubmit(e) {
            var grid = $("#PickDetailList").data("tGrid");
            if (grid == undefined || grid == null) {
                $("#errorsul").html("没有发货明细，请先查询。");
                return;
            }
            var rows = grid.$tbody.children("tr:not(.t-no-data)");
            var idStr = "";
            var qtyStr = "";
            var errorStr = "";
            for (var rowIndex = 0; rowIndex < rows.length; rowIndex++) {
           
                var row = $(rows[rowIndex]);
                var id = row.children().eq(0).text();
                var CurrentPickQty = row.find("#CurrentPickQty").val();
                if (parseFloat(CurrentPickQty) <= 0 || isNaN(CurrentPickQty)) {
                    errorStr += "<li>第" + (rowIndex + 1) + "行数量不正确。</li>";
                    continue;
                }
                if (parseFloat(CurrentPickQty)>0) {
                if (idStr == "") {
                    idStr = id;
                    qtyStr = CurrentPickQty;
                } else {
                    idStr += "," + id;
                    qtyStr += "," + CurrentPickQty;
                }
                }
            }
            if (errorStr!="") {
                $("#errorsul").html(errorStr);
                return;
            }
            if (idStr == "") {
                $("#errorsul").html("没有发货明细。");
                return;
            }
            var data = {
                "idStr": idStr,
                "qtyStr": qtyStr
            }
        
            $.ajax({
                type: "Post",
                dataType: "Json",
                data: data,
                url: "/PickList/PickListship/",
                cache: false,
                success: function (data, textStatus) {
                    
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    var errorMessages = "<li>" + XMLHttpRequest.responseText + "</li>";
                    $("#errorsul").html(errorMessages);
                    $("#successesul").html('');

                }
            });
        }
    </script>
<fieldset>
    @using (Html.BeginForm())
    {   
        <div class="search">
            <div class="search-label">
                <label for="PickListMaster_PickListNo">
                    @Resources.ORD.PickListMaster.PickListMaster_PickListNo
                </label>
            </div>
            <div class="search-field">
                @Html.TextBox("PickListNo", ViewBag.PickListNo!=null?(string)ViewBag.PickListNo : string.Empty)
                @Html.Hidden("Message", ViewBag.Message!=null?(string)ViewBag.Message:string.Empty)
            </div>
              
        </div>
        <div class="search-footer">
         @Html.Hidden("isFromList", true)
            <button type="button" id="btnSearch" onclick="doSearch()">
                @Resources.Global.Button_Search</button>
            @Html.Button(Resources.Global.Button_Ship, "Url_PickList_Ship", new Dictionary<string, string>()
	        {
	            {"type", "button"},
	            {"id", "btnShip"},
                {"needconfirm","true"},
                {"onclick","onSubmit()"}
	        })
        </div>
    }
</fieldset>
    <div id="PickDetailListDiv">
    </div>




