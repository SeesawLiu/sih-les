@model IEnumerable<com.Sconit.Entity.ORD.IpDetail>
<fieldset>
    <legend>@Resources.ORD.IpDetail.IpDetail_Title</legend>
    @(Html.Telerik().Grid(Model)
        .Name("IpDetail")
        .DataKeys(keys =>
        {
            keys.Add(p => p.Id);
        })
        .Columns(columns =>
        {
            columns.Bound(o => o.Id);
            columns.Bound(o => o.Sequence);
            columns.Bound(o => o.IpNo).Width(100);
            columns.Bound(o => o.OrderNo).Width(100);
            columns.Bound(o => o.ExternalOrderNo).Width(100);
            columns.Bound(o => o.ExternalSequence).Width(100);
            columns.Bound(o => o.Flow).Title(Resources.ORD.IpMaster.IpMaster_Flow);
            columns.Bound(o => o.LocationTo);
            columns.Bound(o => o.SAPLocationTo).Title("SAP库位");
            columns.Bound(o => o.Item).Width(100);
            columns.Bound(o => o.ReferenceItemCode);
            columns.Bound(o => o.ItemDescription);
            columns.Bound(o => o.Qty).Width(100);
            columns.Bound(o => o.ReceivedQty).Width(100);
            columns.Bound(o => o.IsClose).ClientTemplate("<input type='checkbox' disabled='disabled' name='IsClose' <#= IsClose? checked='checked' : '' #> />");
            columns.Bound(o => o.Uom);
            columns.Bound(o => o.ManufactureParty);
            columns.Bound(o => o.IsInspect).ClientTemplate("<input type='checkbox' disabled='disabled' name='IsInspect' <#= IsInspect? '' : checked='checked' #> />").Title("是否免检");
            columns.Bound(o => o.UnitCountDescription);
            columns.Bound(o => o.Container).ReadOnly();
            columns.Bound(o => o.ContainerDescription);
            columns.Bound(o => o.IsClose).Hidden();
            if (ViewBag.IsCancel)
            {
                columns.Command(commands => commands.Custom("Cancel")
               .Text("关闭")
                 .HtmlAttributes(new { onClick = "CancelDetailClick(this)", id = "CancelId", href = "#" })
                 );
            }
        })
                .DataBinding(dataBinding => dataBinding.Ajax().Select("_AjaxIpDetailList", "ProcurementIpMaster"))
                                .ClientEvents(events => events.OnDataBinding("IpDetailGrid_OnDataBinding").OnRowDataBound("IpDetailGrid_OnRowDataBound"))
            // .ClientEvents(c => c.OnRowDataBound("RecDetailGrid_OnRowDataBound"))
                .Pageable(settings =>
                {
                    settings.Total(ViewBag.Total != null ? ViewBag.Total : 0);
                    settings.PageSize(ViewBag.PageSize);
                })

        .Sortable()
                .Resizable(resizing => resizing.Columns(true))

    )
    <script type="text/javascript">
        function IpDetailGrid_OnDataBinding(e) {
            i = 0;
            e.data = {
            };
        }

        var i = 0;
        function IpDetailGrid_OnRowDataBound(e) {
            if (i != 0) {
                return;
            }
            var rows = $("tbody").children("tr:not(.t-no-data)");
            // var rows = grid.$tbody.children("tr:not(.t-no-data)");
            for (var rowIndex = 0; rowIndex < rows.length; rowIndex++) {
                var row = $(rows[rowIndex]);
                var IsClose = row.children().eq(21).text();
                var ReceivedQty = row.children().eq(13).text();
                if (IsClose == "true" && parseFloat(ReceivedQty) == 0) {
                    row.children().eq(22).children().replaceWith("<button style='width:60px;height:22px;border:1px solid gray;' onClick = 'RecoveryDetailClick(this)' id='idRecovery'>恢复</button>");
                }
                else if (IsClose == "false" && parseFloat(ReceivedQty) == 0) {
                    row.children().eq(22).children().replaceWith("<button style='width:60px;height:22px;border:1px solid gray;' onClick = 'CancelDetailClick(this)' id='idRecovery'>关闭</button>");
                }
                else {
                    row.children().eq(22).children().hide();
                }
            }
            i = rows.length;

        }

        function CancelDetailClick(e) {
            $(e).attr("href", "#");
            if (confirm("确定此行关闭吗？")) {
                var data = {
                    Id: $(e).parent().parent().children().eq(0).text()
                }
                $.ajax({
                    type: "post",
                    dataType: "json",
                    url: "/ProcurementIpMaster/CancelIpDetail/",
                    data: data,
                    success: function (data, ordermstr) {
                        DisplayJsonMessages(data);
                        $(e).parent().parent().children().eq(14).html("<input type='checkbox' disabled='disabled' name='IsClose'  checked='checked' />");
                        $(e).replaceWith("<button style='width:60px;height:22px;border:1px solid gray;' onClick = 'RecoveryDetailClick(this)' id='CancelId'>恢复</button>");


                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        DisplayTextMessages(XMLHttpRequest.responseText);
                    }
                });
            }
        }


        function RecoveryDetailClick(e) {
            $(e).attr("href", "#");
            if (confirm("确定恢复此行吗？")) {
                var data = {
                    Id: $(e).parent().parent().children().eq(0).text()
                }
                $.ajax({
                    type: "post",
                    dataType: "json",
                    url: "/ProcurementIpMaster/ResumeIpDetail/",
                    data: data,
                    success: function (data, ordermstr) {
                        DisplayJsonMessages(data);
                        $(e).parent().parent().children().eq(14).html("<input type='checkbox' disabled='disabled' name='IsClose'   />");
                        $(e).replaceWith("<button style='width:60px;height:22px;border:1px solid gray;' onClick = 'CancelDetailClick(this)' id='idRecovery'>关闭</button>");

                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        DisplayTextMessages(XMLHttpRequest.responseText);
                    }
                });
            }
        }
    </script>
</fieldset>
